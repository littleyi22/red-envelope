<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°æ˜¥å¥½é‹æŠ½ç´…åŒ… - æ•¸ä½æ•™å­¸ç‰ˆ</title>
    <style>
        /* å…¨åŸŸè¨­å®šèˆ‡å­—å‹ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@600;900&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #8E0000; /* æ·±ç´…èƒŒæ™¯ */
            font-family: 'Noto Serif TC', serif;
        }

        /* èƒŒæ™¯è£é£¾ (CSS é›²ç´‹/åœ“å½¢) */
        .bg-pattern {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(#B71C1C 15%, transparent 16%), radial-gradient(#B71C1C 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            opacity: 0.3;
            z-index: -1;
        }

        /* è¨­å®šæŒ‰éˆ• (é½’è¼ª) */
        #settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.3);
            color: #FFD700;
            border: 2px solid #FFD700;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            z-index: 100;
            transition: transform 0.3s;
        }
        #settings-btn:hover {
            transform: rotate(90deg);
            background: rgba(0, 0, 0, 0.6);
        }

        /* éŸ³æ•ˆæŒ‰éˆ• (å–‡å­) */
        #sound-btn {
            position: absolute;
            top: 20px;
            right: 80px; /* æ”¾åœ¨é½’è¼ªå·¦é‚Š */
            background: rgba(0, 0, 0, 0.3);
            color: #FFD700;
            border: 2px solid #FFD700;
            padding: 10px 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            z-index: 100;
            transition: transform 0.3s;
        }
        #sound-btn:hover {
            transform: scale(1.1);
            background: rgba(0, 0, 0, 0.6);
        }

        /* è¨­å®šé¢æ¿ (Modal) */
        #settings-panel {
            display: none; /* é è¨­éš±è— */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            background: #FFF8E1;
            border: 4px solid #B71C1C;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            padding: 25px;
            z-index: 200;
            text-align: center;
        }

        #settings-panel h2 {
            color: #B71C1C;
            margin-top: 0;
            border-bottom: 2px solid #FFD700;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        label {
            display: block;
            color: #5D4037;
            font-weight: bold;
            margin-bottom: 5px;
        }

        input[type="number"], input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #D7CCC8;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’é–‹å¯¬åº¦ */
        }

        textarea {
            height: 120px;
            resize: vertical;
        }

        .btn-primary {
            background: #B71C1C;
            color: #FFD700;
            border: none;
            padding: 10px 30px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 0 #7F0000;
            transition: all 0.1s;
        }

        .btn-primary:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .hint {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        /* é®ç½©å±¤ */
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 150;
            backdrop-filter: blur(3px);
        }
        
        #canvas-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* é å°¾ç‰ˆæ¬Šå®£å‘Šèˆ‡æŒ‰éˆ• */
        #footer-credits {
            position: fixed;
            bottom: 10px;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 90;
            font-size: 14px;
            pointer-events: none; /* è®“é»æ“Šç©¿é€èƒŒæ™¯ï¼Œä½†é€£çµè¦å¯ä»¥é» */
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px; /* æŒ‰éˆ•èˆ‡é€£çµçš„é–“è· */
        }

        #footer-credits a, #reset-game-btn {
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            padding: 5px 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            pointer-events: auto; /* æ¢å¾©é€£çµé»æ“Š */
            transition: all 0.3s;
            border: none;
            font-family: 'Noto Serif TC', serif;
            font-size: 14px;
            cursor: pointer;
        }

        #footer-credits a:hover, #reset-game-btn:hover {
            color: #FFD700;
            background: rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <!-- èƒŒæ™¯ç´‹è·¯ -->
    <div class="bg-pattern"></div>

    <!-- éŸ³æ•ˆæŒ‰éˆ• -->
    <button id="sound-btn" title="åˆ‡æ›éŸ³æ•ˆ">ğŸ”Š</button>
    <!-- è¨­å®šæŒ‰éˆ• -->
    <button id="settings-btn" title="è¨­å®šèˆ‡é‡ç½®">âš™</button>

    <!-- Canvas ç•«å¸ƒ -->
    <div id="canvas-container">
        <canvas id="gameCanvas"></canvas>
    </div>

    <!-- é å°¾ç‰ˆæ¬Š -->
    <div id="footer-credits">
        <a href="https://www.facebook.com/share/1K5MsceXxS/?mibextid=wwXIfr" target="_blank">2026@å¥•éˆè€å¸«è£½ä½œ</a>
        <button id="reset-game-btn" title="é‡æ–°é–‹å§‹ï¼Œçé …é‡ç½®">é‡ä¾†</button>
    </div>

    <!-- è¨­å®šé¢æ¿èˆ‡é®ç½© -->
    <div id="overlay"></div>
    <div id="settings-panel">
        <h2>ğŸ§§ æ–°æ˜¥æ´»å‹•è¨­å®š</h2>
        
        <div class="form-group">
            <label for="input-title">ä¸»æ¨™é¡Œï¼š</label>
            <input type="text" id="input-title" value="æ–°æ˜¥å¥½é‹æŠ½ç´…åŒ…">
        </div>

        <div class="form-group">
            <label for="input-subtitle">å‰¯æ¨™é¡Œ (å¯ç•™ç©º)ï¼š</label>
            <input type="text" id="input-subtitle" value="ç¥å¤§å®¶é¦¬å¹´è¡Œå¤§é‹">
        </div>
        
        <div class="form-group">
            <label for="input-count">ç´…åŒ…æ•¸é‡ï¼š</label>
            <input type="number" id="input-count" value="9" min="1" max="50">
        </div>

        <div class="form-group">
            <label for="input-prizes">çé …å…§å®¹ (ä¸€è¡Œä¸€å€‹)ï¼š</label>
            <textarea id="input-prizes" placeholder="ä¾‹å¦‚ï¼š
å…æ­»é‡‘ç‰Œ
ä½œæ¥­æ¸›åŠ
å†ä¾†ä¸€æ¬¡">å¤§å‰å¤§åˆ©
èº«é«”å¥åº·
å­¸æ¥­é€²æ­¥
è¬äº‹å¦‚æ„
æ­å–œç™¼è²¡
å¿ƒæƒ³äº‹æˆ
ä½œæ¥­æ¸›åŠ
å†ä¾†ä¸€æ¬¡</textarea>
            <div class="hint">*è‹¥çé …å°‘æ–¼ç´…åŒ…æ•¸é‡ï¼Œå°‡éš¨æ©Ÿé‡è¤‡æˆ–è£œä¸Šã€Œå¤§å‰å¤§åˆ©ã€</div>
        </div>

        <button class="btn-primary" id="start-btn">é–‹å§‹æŠ½ç</button>
    </div>

<script>
    /**
     * è²éŸ³ç®¡ç†ç³»çµ± (ä½¿ç”¨ Web Audio APIï¼Œç„¡éœ€å¤–éƒ¨æª”æ¡ˆ)
     */
    const SoundManager = {
        ctx: null,
        isMuted: false,

        init: function() {
            // åˆå§‹åŒ– AudioContext (éœ€åœ¨ä½¿ç”¨è€…äº’å‹•å¾Œè§¸ç™¼)
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!this.ctx && AudioContext) {
                this.ctx = new AudioContext();
            }
        },

        playTone: function(freq, type, duration, startTime = 0) {
            if (this.isMuted || !this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            
            osc.type = type; // 'sine', 'square', 'sawtooth', 'triangle'
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime + startTime);
            
            gain.gain.setValueAtTime(0.1, this.ctx.currentTime + startTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + startTime + duration);

            osc.connect(gain);
            gain.connect(this.ctx.destination);
            
            osc.start(this.ctx.currentTime + startTime);
            osc.stop(this.ctx.currentTime + startTime + duration);
        },

        playPop: function() {
            // é–‹å•Ÿç´…åŒ…çš„ã€Œå•µã€è²
            this.init();
            if (this.isMuted || !this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            
            osc.frequency.setValueAtTime(400, this.ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(800, this.ctx.currentTime + 0.1);
            
            gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);

            osc.connect(gain);
            gain.connect(this.ctx.destination);
            
            osc.start();
            osc.stop(this.ctx.currentTime + 0.1);
        },

        playWin: function() {
            // ä¸­ççš„ã€Œå®å’šã€æ…¶ç¥è²
            this.init();
            if (this.isMuted) return;
            // æ’­æ”¾ä¸€ä¸²é«˜éŸ³
            this.playTone(880, 'sine', 0.1, 0);       // A5
            this.playTone(1108, 'sine', 0.1, 0.1);    // C#6
            this.playTone(1318, 'sine', 0.3, 0.2);    // E6
        },
        
        playClick: function() {
            // æŒ‰éˆ•é»æ“Šè²
            this.init();
            if (this.isMuted) return;
            this.playTone(600, 'triangle', 0.05, 0);
        },

        toggleMute: function() {
            this.isMuted = !this.isMuted;
            return this.isMuted;
        }
    };


    /**
     * æ ¸å¿ƒé‚è¼¯å€
     */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // éŠæˆ²ç‹€æ…‹èˆ‡è³‡æ–™
    let envelopes = [];
    let particles = [];
    let config = {
        title: "æ–°æ˜¥å¥½é‹æŠ½ç´…åŒ…",
        subtitle: "ç¥å¤§å®¶é¦¬å¹´è¡Œå¤§é‹",
        count: 9, 
        prizes: [],
        cols: 4,
        rows: 2
    };

    // UI å…ƒç´ 
    const settingsBtn = document.getElementById('settings-btn');
    const soundBtn = document.getElementById('sound-btn'); // æ–°å¢éŸ³æ•ˆæŒ‰éˆ•
    const settingsPanel = document.getElementById('settings-panel');
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('start-btn');
    const inputCount = document.getElementById('input-count');
    const inputPrizes = document.getElementById('input-prizes');
    const inputTitle = document.getElementById('input-title');
    const inputSubtitle = document.getElementById('input-subtitle');
    const resetGameBtn = document.getElementById('reset-game-btn');

    /**
     * ç²’å­ç³»çµ± (ç…™ç«/å½©å¸¶)
     */
    class Particle {
        constructor(x, y, type) {
            this.x = x;
            this.y = y;
            // éš¨æ©Ÿå™´ç™¼è§’åº¦èˆ‡é€Ÿåº¦
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 5 + 2;
            this.vx = Math.cos(angle) * speed;
            this.vy = Math.sin(angle) * speed;
            this.gravity = 0.1;
            this.friction = 0.95;
            this.alpha = 1;
            this.decay = Math.random() * 0.02 + 0.01;
            
            // é¡è‰²ï¼šé‡‘ã€ç´…ã€ç™½
            const colors = ['#FFD700', '#FF5722', '#FFFFFF', '#FFC107'];
            this.color = colors[Math.floor(Math.random() * colors.length)];
            this.size = Math.random() * 5 + 2;
            this.type = type; // 'circle' or 'rect' (confetti)
        }

        update() {
            this.vx *= this.friction;
            this.vy *= this.friction;
            this.vy += this.gravity;
            this.x += this.vx;
            this.y += this.vy;
            this.alpha -= this.decay;
        }

        draw() {
            ctx.save();
            ctx.globalAlpha = this.alpha;
            ctx.fillStyle = this.color;
            
            if (this.type === 'rect') {
                ctx.translate(this.x, this.y);
                ctx.rotate(this.vx * 0.5); // æ—‹è½‰æ•ˆæœ
                ctx.fillRect(-this.size/2, -this.size/2, this.size, this.size);
            } else {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size/2, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.restore();
        }
    }

    /**
     * ç´…åŒ…é¡åˆ¥
     */
    class Envelope {
        constructor(x, y, w, h, prize) {
            this.x = x;
            this.y = y;
            this.w = w;
            this.h = h;
            this.prize = prize;
            this.isOpen = false;
            this.scale = 1;
            this.targetScale = 1;
            this.openAnimProgress = 0; // 0 åˆ° 1
        }

        draw() {
            // å‹•ç•«ç¸®æ”¾è¨ˆç®—
            this.scale += (this.targetScale - this.scale) * 0.1;
            
            const cx = this.x + this.w / 2;
            const cy = this.y + this.h / 2;

            ctx.save();
            ctx.translate(cx, cy);
            ctx.scale(this.scale, this.scale);
            ctx.translate(-cx, -cy);

            // ç¹ªè£½é™°å½±
            ctx.shadowColor = "rgba(0, 0, 0, 0.3)";
            ctx.shadowBlur = 10;
            ctx.shadowOffsetY = 5;

            if (!this.isOpen) {
                this.drawClosed();
            } else {
                this.drawOpened();
            }

            ctx.restore();
        }

        drawClosed() {
            // ç´…åŒ…ä¸»é«” (ç´…è‰²çŸ©å½¢)
            ctx.fillStyle = "#D32F2F";
            ctx.fillRect(this.x, this.y, this.w, this.h);

            // ç´…åŒ…è“‹å­ (æ›²ç·š)
            ctx.beginPath();
            ctx.moveTo(this.x, this.y);
            ctx.quadraticCurveTo(this.x + this.w / 2, this.y + this.h * 0.6, this.x + this.w, this.y);
            ctx.fillStyle = "#B71C1C"; // è¼ƒæ·±çš„ç´…è‰²
            ctx.fill();
            ctx.closePath();
            
            // è£é£¾ç·š (é‡‘è‰²é‚Šæ¡†)
            ctx.strokeStyle = "#FFD700";
            ctx.lineWidth = 2;
            ctx.strokeRect(this.x + 5, this.y + 5, this.w - 10, this.h - 10);

            // ä¸­å¤®ã€Œç¦ã€å­—æˆ–éŠ…éŒ¢è£é£¾
            const centerX = this.x + this.w / 2;
            const centerY = this.y + this.h * 0.35;
            
            // é‡‘è‰²åœ“åœˆ
            ctx.beginPath();
            ctx.arc(centerX, centerY, this.w * 0.15, 0, Math.PI * 2);
            ctx.fillStyle = "#FFD700";
            ctx.fill();
            ctx.shadowColor = "transparent"; // æ¸…é™¤é™°å½±ä»¥å…æ–‡å­—æ¨¡ç³Š

            // å­—
            ctx.fillStyle = "#D32F2F";
            ctx.font = `bold ${this.w * 0.15}px "Noto Serif TC"`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("ç¦", centerX, centerY);
        }

        drawOpened() {
            // èƒŒæ™¯å¡ç‰‡ (ç±³è‰²)
            ctx.fillStyle = "#FFF8E1";
            ctx.fillRect(this.x, this.y, this.w, this.h);
            
            // é‚Šæ¡†
            ctx.strokeStyle = "#D32F2F";
            ctx.lineWidth = 3;
            ctx.strokeRect(this.x, this.y, this.w, this.h);

            // çé …æ–‡å­—
            ctx.shadowColor = "transparent";
            ctx.fillStyle = "#3E2723";
            
            // è‡ªå‹•èª¿æ•´å­—é«”å¤§å°ä»¥é©æ‡‰æ¡†æ¡†
            let fontSize = this.w * 0.15;
            if (this.prize.length > 5) fontSize = this.w * 0.1;
            
            ctx.font = `bold ${fontSize}px "Noto Serif TC"`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            
            // ç°¡å–®çš„æ–‡å­—æ›è¡Œè™•ç† (å¦‚æœæ–‡å­—å¤ªé•·)
            const words = this.prize.split('');
            const centerX = this.x + this.w / 2;
            const centerY = this.y + this.h / 2;

            ctx.fillText(this.prize, centerX, centerY);
            
            // ä¸Šæ–¹è£é£¾å­—
            ctx.font = `italic ${this.w * 0.08}px serif`;
            ctx.fillStyle = "#D32F2F";
            ctx.fillText("æ­å–œç²å¾—", centerX, this.y + this.h * 0.2);
        }

        checkClick(mx, my) {
            return (mx > this.x && mx < this.x + this.w &&
                    my > this.y && my < this.y + this.h);
        }

        open() {
            if (this.isOpen) return;
            this.isOpen = true;
            this.targetScale = 1.1; // æ”¾å¤§ä¸€é»
            
            // æ’­æ”¾éŸ³æ•ˆ
            SoundManager.playPop();
            setTimeout(() => SoundManager.playWin(), 100);

            // è§¸ç™¼ç²’å­ç‰¹æ•ˆ
            createParticles(this.x + this.w/2, this.y + this.h/2);
            
            // çŸ­æš«éœ‡å‹•å¾Œå›å¾©å¤§å°
            setTimeout(() => {
                this.targetScale = 1.0;
            }, 200);
        }
    }

    /**
     * ç³»çµ±åŠŸèƒ½å‡½æ•¸
     */
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        // å¦‚æœæ­£åœ¨éŠæˆ²ä¸­ï¼Œéœ€è¦é‡æ–°è¨ˆç®—ç´…åŒ…ä½ç½® (é€™è£¡ç°¡å–®åšï¼šé‡ç½®ä½ç½®ä½†ä¿ç•™ç‹€æ…‹)
        if (envelopes.length > 0) {
            initEnvelopes(true);
        }
    }

    function createParticles(x, y) {
        for (let i = 0; i < 60; i++) {
            particles.push(new Particle(x, y, Math.random() > 0.5 ? 'circle' : 'rect'));
        }
    }

    // è¨ˆç®—æœ€ä½³ç¶²æ ¼ä½ˆå±€ (å„ªåŒ–ç‰ˆï¼šå°‹æ‰¾æœ€æ–¹æ­£ã€æœ€å°ç¨±çš„æ’åˆ—)
    function calculateGrid(total, width, height) {
        const screenRatio = width / height;
        // å‡è¨­ç´…åŒ…é•·å¯¬æ¯”ç´„ç‚º 1:1.4 (width / height)
        // è€ƒæ…®é–“è·ï¼Œæˆ‘å€‘ç”¨ä¸€å€‹è¿‘ä¼¼å€¼
        const cardRatio = 1 / 1.4;

        let bestConfig = { cols: Math.ceil(Math.sqrt(total)), rows: Math.ceil(total / Math.ceil(Math.sqrt(total))) };
        let minScore = Infinity;

        // å˜—è©¦å„ç¨®åˆ—æ•¸ (cols)ï¼Œå¾ 1 åˆ° total
        // æˆ‘å€‘çµ¦äºˆ "å¡«æ»¿çŸ©å½¢" è¼ƒé«˜çš„æ¬Šé‡ï¼Œé¿å…å‡ºç¾åƒ 4,4,1 é€™ç¨®æ’åˆ— (é›–ç„¶ç¬¦åˆæ¯”ä¾‹ä½†ä¸ç¾è§€)
        // è€Œæ›´å‚¾å‘æ–¼ 3,3,3 é€™ç¨®æ’åˆ—
        for (let c = 1; c <= total; c++) {
            const r = Math.ceil(total / c);
            
            // è¨ˆç®—è©²ç¶²æ ¼çš„é•·å¯¬æ¯”
            // ç¶²æ ¼ç¸½å¯¬ ~ c
            // ç¶²æ ¼ç¸½é«˜ ~ r * 1.4
            const gridRatio = c / (r * 1.4);
            
            // åˆ†æ•¸ 1: èˆ‡è¢å¹•æ¯”ä¾‹çš„å·®è· (è¶Šå°è¶Šå¥½)
            const ratioDiff = Math.abs(gridRatio - screenRatio);
            
            // åˆ†æ•¸ 2: å®Œæ•´åº¦ (ç¼ºè§’è¶Šå°‘è¶Šå¥½)
            // (c * r) æ˜¯è©²ç¶²æ ¼èƒ½è£çš„ç¸½æ•¸ï¼Œtotal æ˜¯å¯¦éš›æ•¸é‡
            // emptySpots æ˜¯æœ€å¾Œä¸€è¡Œçš„ç¼ºå£
            const emptySpots = (c * r) - total;
            
            // æˆ‘å€‘åŠ é‡ emptySpots çš„æ¬Šé‡ï¼Œè®“å®ƒå„ªå…ˆé¸æ“‡æ–¹æ­£çš„æ’åˆ—
            // ä¾‹å¦‚ 9 å€‹ï¼š3x3 (0ç¼ºå£) å„ªæ–¼ 4x3 (3ç¼ºå£)
            // ä¾‹å¦‚ 7 å€‹ï¼š4x2 (1ç¼ºå£) å„ªæ–¼ 3x3 (2ç¼ºå£)
            const completenessScore = emptySpots * 0.8; 

            // ç¶œåˆåˆ†æ•¸
            const score = ratioDiff + completenessScore;

            if (score < minScore) {
                minScore = score;
                bestConfig = { cols: c, rows: r };
            }
        }
        return bestConfig;
    }

    function initEnvelopes(keepState = false) {
        // è¨­å®šç´…åŒ…åŸºç¤å¤§å°
        const padding = 20; // é‚Šè·
        const gap = 20;     // ç´…åŒ…é–“è·
        
        // é ç•™æ¨™é¡Œç©ºé–“ (å¦‚æœæœ‰æ¨™é¡Œçš„è©±)
        const headerHeight = (config.title || config.subtitle) ? Math.min(canvas.height * 0.25, 150) : 0;
        const footerHeight = 40; // é¿é–‹é å°¾é€£çµ
        
        // è¨ˆç®—ç¶²æ ¼
        // å‚³å…¥çš„ height è¦æ‰£æ‰æ¨™é¡Œå€ï¼Œé¿å…é‡ç–Š
        const grid = calculateGrid(config.count, canvas.width, canvas.height - headerHeight);
        config.cols = grid.cols;
        config.rows = grid.rows;

        // è¨ˆç®—æ¯å€‹ç´…åŒ…çš„å¤§å° (ä¿æŒé•·å¯¬æ¯” 2:3)
        const availableW = canvas.width - (padding * 2) - ((config.cols - 1) * gap);
        const availableH = canvas.height - headerHeight - footerHeight - (padding * 2) - ((config.rows - 1) * gap);
        
        let envW = availableW / config.cols;
        let envH = envW * 1.4; // æ¯”ä¾‹

        // å¦‚æœé«˜åº¦è¶…å‡ºï¼Œå‰‡ä»¥é«˜åº¦ç‚ºæº–
        if (envH * config.rows > availableH) {
            envH = availableH / config.rows;
            envW = envH / 1.4;
        }

        // é™åˆ¶æœ€å¤§å°ºå¯¸ï¼Œé¿å…åœ¨å¤§è¢å¹•ç´…åŒ…å¤ªå¤§
        const MAX_W = 200;
        if (envW > MAX_W) {
            envW = MAX_W;
            envH = MAX_W * 1.4;
        }

        // è¨ˆç®—å‚ç›´èµ·å§‹ä½ç½® (å‚ç›´ç½®ä¸­ï¼Œä½†è¦åŠ ä¸Šæ¨™é¡Œåç§»é‡)
        const totalGridH = config.rows * envH + (config.rows - 1) * gap;
        // åœ¨ã€Œæ‰£é™¤æ¨™é¡Œå¾Œçš„å‰©é¤˜ç©ºé–“ã€ä¸­ç½®ä¸­ï¼Œç„¶å¾Œå†åŠ ä¸Š headerHeight
        const startY = headerHeight + (availableH - totalGridH) / 2 + padding;

        // ç”¢ç”Ÿæˆ–æ›´æ–°ç´…åŒ…
        if (!keepState) {
            envelopes = [];
            // æº–å‚™çé …æ±  (æ´—ç‰Œ)
            let prizePool = [...config.prizes];
            // å¦‚æœçé …ä¸å¤ ï¼Œéš¨æ©Ÿè£œ
            while (prizePool.length < config.count) {
                if (config.prizes.length > 0) {
                     prizePool.push(config.prizes[Math.floor(Math.random() * config.prizes.length)]);
                } else {
                    prizePool.push("å¤§å‰å¤§åˆ©");
                }
            }
            // å†æ¬¡æ‰“äº‚
            prizePool.sort(() => Math.random() - 0.5);

            let index = 0;
            for (let r = 0; r < config.rows; r++) {
                // è¨ˆç®—é€™ä¸€è¡Œæœ‰å¹¾å€‹ç´…åŒ…
                let itemsInRow = config.cols;
                // å¦‚æœæ˜¯æœ€å¾Œä¸€è¡Œï¼Œä¸”ç„¡æ³•æ•´é™¤ï¼Œå‰‡è¨ˆç®—å‰©é¤˜æ•¸é‡
                if (r === config.rows - 1) {
                    const remainder = config.count % config.cols;
                    if (remainder !== 0) {
                        itemsInRow = remainder;
                    }
                }

                // è¨ˆç®—é€™ä¸€è¡Œçš„å¯¬åº¦ï¼Œä»¥ä¾¿æ°´å¹³ç½®ä¸­
                const rowWidth = itemsInRow * envW + (itemsInRow - 1) * gap;
                const rowStartX = (canvas.width - rowWidth) / 2;

                for (let c = 0; c < itemsInRow; c++) {
                    if (index >= config.count) break;
                    
                    const x = rowStartX + c * (envW + gap);
                    const y = startY + r * (envH + gap);
                    
                    envelopes.push(new Envelope(x, y, envW, envH, prizePool[index]));
                    index++;
                }
            }
        } else {
            // åƒ…æ›´æ–°ä½ç½® (Responsive resize)
            let index = 0;
            for (let r = 0; r < config.rows; r++) {
                let itemsInRow = config.cols;
                if (r === config.rows - 1) {
                    const remainder = config.count % config.cols;
                    if (remainder !== 0) itemsInRow = remainder;
                }

                const rowWidth = itemsInRow * envW + (itemsInRow - 1) * gap;
                const rowStartX = (canvas.width - rowWidth) / 2;

                for (let c = 0; c < itemsInRow; c++) {
                    if (index >= envelopes.length) break;
                    const x = rowStartX + c * (envW + gap);
                    const y = startY + r * (envH + gap);
                    
                    envelopes[index].x = x;
                    envelopes[index].y = y;
                    envelopes[index].w = envW;
                    envelopes[index].h = envH;
                    index++;
                }
            }
        }
    }

    function drawTitles() {
        if (!config.title && !config.subtitle) return;

        ctx.save();
        ctx.shadowColor = "rgba(0, 0, 0, 0.5)";
        ctx.shadowBlur = 15;
        ctx.textAlign = "center";
        
        // ä¸»æ¨™é¡Œ
        if (config.title) {
            ctx.fillStyle = "#FFD700"; // é‡‘è‰²
            // æ ¹æ“šè¢å¹•å¯¬åº¦å‹•æ…‹èª¿æ•´å­—é«”å¤§å°ï¼Œæœ€å¤§ 60px
            const titleSize = Math.min(canvas.width * 0.1, 60);
            ctx.font = `900 ${titleSize}px "Noto Serif TC"`;
            ctx.fillText(config.title, canvas.width / 2, titleSize + 30);
        }

        // å‰¯æ¨™é¡Œ
        if (config.subtitle) {
            ctx.fillStyle = "#FFECB3"; // æ·¡é‡‘è‰²
            const subSize = Math.min(canvas.width * 0.05, 30);
            // å¦‚æœæœ‰ä¸»æ¨™é¡Œï¼Œå‰¯æ¨™é¡Œä½ç½®è¦å¾€ä¸‹
            const offset = config.title ? (Math.min(canvas.width * 0.1, 60) + 40) : 40;
            ctx.font = `600 ${subSize}px "Noto Serif TC"`;
            ctx.fillText(config.subtitle, canvas.width / 2, offset + subSize);
        }

        ctx.restore();
    }

    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ç¹ªè£½æ¨™é¡Œ
        drawTitles();
        
        // ç¹ªè£½ç´…åŒ…
        envelopes.forEach(env => env.draw());

        // ç¹ªè£½ç²’å­ (å€’åºä»¥æ–¹ä¾¿åˆªé™¤)
        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].update();
            particles[i].draw();
            if (particles[i].alpha <= 0) {
                particles.splice(i, 1);
            }
        }

        requestAnimationFrame(animate);
    }

    /**
     * äº‹ä»¶ç›£è½
     */
    
    // é»æ“Šäº‹ä»¶
    canvas.addEventListener('click', (e) => {
        // é¦–æ¬¡äº’å‹•åˆå§‹åŒ–éŸ³æ•ˆå¼•æ“
        SoundManager.init();
        
        // å–å¾—æ»‘é¼ åœ¨ canvas ä¸Šçš„ä½ç½® (éœ€è€ƒæ…® CSS ç¸®æ”¾ï¼Œé›–ç„¶é€™è£¡æ˜¯å…¨è¢å¹•)
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;

        // æª¢æŸ¥æ˜¯å¦é»åˆ°ç´…åŒ… (åå‘éæ­·ï¼Œç¢ºä¿å…ˆé»åˆ°ä¸Šå±¤ï¼Œé›–ç›®å‰æ²’é‡ç–Š)
        for (let i = envelopes.length - 1; i >= 0; i--) {
            if (envelopes[i].checkClick(mx, my)) {
                envelopes[i].open();
                break; // ä¸€æ¬¡åªé–‹ä¸€å€‹
            }
        }
    });

    // è¨­å®šé¢æ¿æ§åˆ¶
    function toggleSettings(show) {
        SoundManager.playClick();
        if (show) {
            settingsPanel.style.display = 'block';
            overlay.style.display = 'block';
        } else {
            settingsPanel.style.display = 'none';
            overlay.style.display = 'none';
        }
    }

    // éŸ³æ•ˆæŒ‰éˆ•äº‹ä»¶
    soundBtn.addEventListener('click', () => {
        const isMuted = SoundManager.toggleMute();
        soundBtn.innerText = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
        SoundManager.playClick();
    });

    // ä¿®æ”¹ï¼šåŠ å…¥å¯†ç¢¼é©—è­‰
    settingsBtn.addEventListener('click', () => {
        SoundManager.playClick();
        const password = prompt("è«‹è¼¸å…¥è€å¸«å¯†ç¢¼ä»¥é€²å…¥è¨­å®šï¼š", "");
        if (password === "0000") {
            toggleSettings(true);
        } else if (password !== null) {
            // å¦‚æœä½¿ç”¨è€…æŒ‰äº†å–æ¶ˆ (null)ï¼Œå°±ä¸è·³éŒ¯èª¤è¨Šæ¯
            alert("å¯†ç¢¼éŒ¯èª¤ï¼");
        }
    });

    overlay.addEventListener('click', () => toggleSettings(false));

    // é–‹å§‹/é‡ç½®æŒ‰éˆ•
    startBtn.addEventListener('click', () => {
        SoundManager.playClick();
        // è®€å–è¨­å®š
        const count = parseInt(inputCount.value) || 8;
        const rawPrizes = inputPrizes.value.split('\n').map(p => p.trim()).filter(p => p !== '');
        
        // è®€å–æ¨™é¡Œè¨­å®š
        config.title = inputTitle.value.trim();
        config.subtitle = inputSubtitle.value.trim();

        config.count = count;
        config.prizes = rawPrizes.length > 0 ? rawPrizes : ["å¤§å‰å¤§åˆ©"];
        
        // åˆå§‹åŒ–éŠæˆ²
        initEnvelopes(false);
        toggleSettings(false);
    });

    // æ–°å¢ï¼šé‡ä¾†æŒ‰éˆ•åŠŸèƒ½
    resetGameBtn.addEventListener('click', () => {
        SoundManager.playClick();
        if(confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿæ‰€æœ‰ç´…åŒ…å°‡æœƒè“‹å›ä¸¦é‡æ–°åˆ†é…çé …ã€‚')) {
            initEnvelopes(false);
        }
    });

    // åˆå§‹åŒ–
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas(); // è¨­å®šç•«å¸ƒå¤§å°
    
    // é è¨­é–‹å•Ÿè¨­å®šé¢æ¿è®“ä½¿ç”¨è€…è¨­å®šï¼Œæˆ–è€…ç›´æ¥é–‹å§‹ç¯„ä¾‹
    // é€™è£¡æˆ‘å€‘ç›´æ¥ç”¢ç”Ÿç¯„ä¾‹ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥å…ˆç©
    const rawPrizes = inputPrizes.value.split('\n').map(p => p.trim()).filter(p => p !== '');
    config.prizes = rawPrizes;
    initEnvelopes(false);
    
    animate();

</script>
</body>
</html>